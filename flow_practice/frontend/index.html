<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 400px; margin: 30px auto; }
  h1 { color: #333; margin-bottom: 20px; }
  label { display: block; margin-top: 15px; font-weight: bold; }
  input[type=text], input[type=password], input[type=date] {
    width: 100%; padding: 8px; margin-top: 5px;
    border: 1px solid #ccc; border-radius: 4px;
    font-style: normal;
    color: #000;
  }
  input[type=text]::placeholder, input[type=password]::placeholder {
    color: #808080; font-style: italic;
  }
  input:focus { outline: none; border-color: #57a639; box-shadow: 0 0 3px #57a639; }
  .error { color: #ff0000; font-size: 0.9em; margin-top: 3px; }
  .success { color: #3caa3c; font-size: 0.9em; margin-top: 3px; }
  button {
    margin-top: 20px; background-color: #3caa3c; color: white;
    border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;
    font-size: 1em;
  }
  button:disabled {
    background-color: #8fbc8f; cursor: default;
  }
  input[disabled] {
    background-color: #f0f0f0; color: #999;
    border-color: #ccc;
  }
</style>
</head>
<body>

<h1>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h1>

<form id="editForm" novalidate autocomplete="off">

  <label for="login">–õ–æ–≥–∏–Ω:</label>
  <input id="login" name="login" type="text" maxlength="10" placeholder="Max 10 —Å–∏–º–≤–æ–ª–æ–≤" />
  <div id="loginError" class="error"></div>

  <label for="password">–ü–∞—Ä–æ–ª—å:</label>
  <input id="password" name="password" type="text" minlength="7" maxlength="16"
        placeholder="Min: 8 —Å–∏–º–≤–æ–ª–æ–≤ - Max: 16 —Å–∏–º–≤–æ–ª–æ–≤" />
  <div id="passwordError" class="error"></div>

  <label for="birthdate">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</label>
  <input id="birthdate" name="birthdate" type="date" />
  <div id="birthdateError" class="error"></div>
  <div id="birthdateSuccess" class="success"></div>

  <button id="submitBtn" type="submit" disabled>–ü—Ä–∏–Ω—è—Ç—å</button>

</form>

<script>
(() => {
  const form = document.getElementById('editForm');
  const loginInput = form.login;
  const passwordInput = form.password;
  const birthdateInput = form.birthdate;
  const submitBtn = form.submitBtn;

  const loginError = document.getElementById('loginError');
  const passwordError = document.getElementById('passwordError');
  const birthdateError = document.getElementById('birthdateError');
  const birthdateSuccess = document.getElementById('birthdateSuccess');

  let oldData = { login: '', password: '', date: '' };

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL –¥–ª—è –±—ç–∫–∞
  const BACKEND_HOST = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
    ? 'http://localhost:8000'
    : 'http://backend:8000';

  function validateLogin(value) {
    if (value === '') return null;
    if (value.length > 10) return '–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞–∫—Å–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤';
    if (!/^[A-Za-z0-9]+$/.test(value)) return '–õ–æ–≥–∏–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü—É, —Ü–∏—Ñ—Ä—ã –∏ –Ω–∏–∂–Ω–µ–µ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ';
    return null;
  }

  function validatePassword(value) {
    if (value === '') return null;
    if (value.length < 7 || value.length > 16) return '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 8 –¥–æ 16 —Å–∏–º–≤–æ–ª–æ–≤';
    for (let ch of value) {
      if (ch === ' ' || ch.charCodeAt(0) < 32 || ch.charCodeAt(0) > 126) {
        return '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ ASCII —Å–∏–º–≤–æ–ª—ã –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤';
      }
    }
    return null;
  }

  function validateDate(value) {
    if (value === "") return null;
    const today = new Date();
    const d = new Date(value);
    if (d > today) return '—É—Ç–æ—á–Ω–∏—Ç—å –Ω—É–∂–Ω—ã–π —Ç–µ–∫—Å—Ç —É –∑–∞–∫–∞–∑—á–∏–∫–∞';
    const age = today.getFullYear() - d.getFullYear() - (today.getMonth() < d.getMonth() || (today.getMonth() === d.getMonth() && today.getDate() < d.getDate()) ? 1 : 0);
    if (age < 18) return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏–º';
    if (age > 99) return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç–∞—Ä—à–µ 99 –ª–µ—Ç';
    return null;
  }

  function clearErrors() {
    loginError.textContent = '';
    passwordError.textContent = '';
    birthdateError.textContent = '';
    birthdateSuccess.textContent = '';
  }

  function setFieldDisabled(disabled) {
    loginInput.disabled = disabled;
    passwordInput.disabled = disabled;
    birthdateInput.disabled = disabled;
  }

  async function loadOldData() {
    try {
      const resp = await fetch(`${BACKEND_HOST}/`);
      if (!resp.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ');
      const data = await resp.json();
      oldData.login = data.login;
      oldData.password = data.password;
      oldData.date = data.date;

      loginInput.value = '';
      passwordInput.value = '';
      birthdateInput.value = '';

      const todayISO = new Date().toISOString().split('T')[0];
      birthdateInput.setAttribute('max', todayISO);

      const minYear = new Date();
      minYear.setFullYear(minYear.getFullYear() - 60);
      minYear.setDate(minYear.getDate() + 1);
      birthdateInput.setAttribute('min', minYear.toISOString().split('T')[0]);

      updateSubmitState();
    } catch (e) {
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ' + e.message);
    }
  }

  function hasAnyInput() {
    return !!(loginInput.value || passwordInput.value || birthdateInput.value);
  }
  function updateSubmitState() {
    submitBtn.disabled = !hasAnyInput();
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearErrors();

    const loginVal = loginInput.value;
    const passwordVal = passwordInput.value;
    const dateVal = birthdateInput.value;

    let hasError = false;

    const loginErr = validateLogin(loginVal);
    if (loginErr) { loginError.textContent = loginErr; hasError = true; }

    const passErr = validatePassword(passwordVal);
    if (passErr) { passwordError.textContent = passErr; hasError = true; }

    const dateErr = validateDate(dateVal === oldData.date ? dateVal : (dateVal || ""));
    if (dateErr) { birthdateError.textContent = dateErr; hasError = true; }

    if (loginVal !== '' && loginVal === oldData.login && !loginErr) {
      loginError.textContent = '–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
      hasError = true;
    }
    if (passwordVal !== '' && passwordVal === oldData.password && !passErr) {
      passwordError.textContent = '–¢–∞–∫–æ–π –ø–∞—Ä–æ–ª—å —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
      hasError = true;
    }
    if (dateVal !== '' && dateVal === oldData.date && !dateErr) {
      birthdateError.textContent = '–¢–∞–∫–æ–π –≤–æ–∑—Ä–∞—Å—Ç —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
      hasError = true;
    }

    if (hasError) {
      submitBtn.disabled = false;
      return;
    }

    const birthVal = (dateVal && dateVal !== oldData.date) ? dateVal : "";
    const body = { login: loginVal, password: passwordVal, date: birthVal };

    try {
      const resp = await fetch(`${BACKEND_HOST}/update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (resp.status === 200) {
        const result = await resp.json();
        setFieldDisabled(true);
        submitBtn.disabled = true;
        birthdateSuccess.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';

        oldData.login = result.login ?? (loginVal || oldData.login);
        oldData.password = result.password ?? (passwordVal || oldData.password);
        oldData.date = result.date ?? (birthVal || oldData.date);
      } else if (resp.status === 400) {
        const err = await resp.json();
        if (err.detail) {
          if (err.detail.login) loginError.textContent = err.detail.login;
          if (err.detail.password) passwordError.textContent = err.detail.password;
          if (err.detail.date) birthdateError.textContent = err.detail.date;
        }
        submitBtn.disabled = false;
      } else {
        alert('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: ' + resp.status);
        submitBtn.disabled = false;
      }
    } catch (e) {
      alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message);
      submitBtn.disabled = false;
    }
  });

  const focusOrder = [loginInput, passwordInput, birthdateInput, submitBtn];

  // üö´ –ó–∞–ø—Ä–µ—Ç –≤—Å—Ç–∞–≤–∫–∏ –≤ –ø–æ–ª–µ "–õ–æ–≥–∏–Ω"
  loginInput.addEventListener('paste', e => {
    e.preventDefault();
  });

  let focusIndex = 0;
  focusOrder.forEach((el, idx) => {
    el.addEventListener('focus', () => {
      focusIndex = idx;
    });
  });

  function focusNext() {
    const len = focusOrder.length;
    for (let i = 1; i <= len; i++) {
      const idx = (focusIndex + i) % len;
      if (!focusOrder[idx].disabled) {
        focusIndex = idx;
        focusOrder[focusIndex].focus();
        return;
      }
    }
  }

  function focusPrev() {
    const len = focusOrder.length;
    for (let i = 1; i <= len; i++) {
      const idx = (focusIndex - i + len) % len;
      if (!focusOrder[idx].disabled) {
        focusIndex = idx;
        focusOrder[focusIndex].focus();
        return;
      }
    }
  }

  form.addEventListener('keydown', e => {
    if (e.key === 'Tab') {
      e.preventDefault();
      if (e.shiftKey) focusPrev(); else focusNext();
    } else if (e.key === 'Enter') {
      e.preventDefault();
      const active = document.activeElement;
      if (active === loginInput || active === passwordInput) { active.blur(); }
      else if (active === birthdateInput) { active.blur(); updateSubmitState(); }
      else if (active === submitBtn && !submitBtn.disabled) { submitBtn.click(); }
    }
  });

  loginInput.addEventListener('input', () => { loginError.textContent = ''; updateSubmitState(); });
  passwordInput.addEventListener('input', () => { passwordError.textContent = ''; updateSubmitState(); });
  birthdateInput.addEventListener('input', () => { birthdateError.textContent = ''; birthdateSuccess.textContent = ''; updateSubmitState(); });

  loadOldData();

})();
</script>

</body>
</html>
